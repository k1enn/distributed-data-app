package com.k1en;

import javafx.application.Application;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.stage.Stage;
import com.k1en.database.DatabaseManager;
import com.k1en.model.NhomNC;

import java.sql.*;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

public class MainApp extends Application {

    private DatabaseManager dbManager;
    private TableView<NhomNC> tableView;
    private TextField txtMaNhom, txtTenNhom, txtTenPhong;
    private TextArea txtResults;
    private ComboBox<String> cmbTransparencyLevel;

    @Override
    public void start(Stage primaryStage) {
        primaryStage.setTitle("Distributed Database Manager");

        // Initialize database connection
        try {
            dbManager = new DatabaseManager();
        } catch (SQLException e) {
            showAlert("Database Connection Error", e.getMessage());
            return;
        }

        // Create main layout
        BorderPane root = new BorderPane();
        root.setPadding(new Insets(10));

        // Top: Input form
        VBox topSection = createInputForm();
        root.setTop(topSection);

        // Center: Table view
        tableView = createTableView();
        root.setCenter(tableView);

        // Bottom: Query results
        txtResults = new TextArea();
        txtResults.setPrefHeight(100);
        txtResults.setEditable(false);
        txtResults.setPromptText("Query results will appear here...");
        root.setBottom(txtResults);

        // Create scene
        Scene scene = new Scene(root, 900, 600);
        primaryStage.setScene(scene);
        primaryStage.setOnCloseRequest(e -> closeDatabase());
        primaryStage.show();

        // Load initial data
        loadData();
    }

    private VBox createInputForm() {
        VBox vbox = new VBox(10);
        vbox.setPadding(new Insets(10));
        vbox.setStyle("-fx-background-color: #f4f4f4; -fx-border-color: #cccccc;");

        // Input fields
        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(10);

        Label lblMaNhom = new Label("Mã Nhóm:");
        txtMaNhom = new TextField();
        txtMaNhom.setPromptText("NC01");

        Label lblTenNhom = new Label("Tên Nhóm:");
        txtTenNhom = new TextField();
        txtTenNhom.setPromptText("Nhóm Nghiên Cứu 1");

        Label lblTenPhong = new Label("Tên Phòng:");
        txtTenPhong = new TextField();
        txtTenPhong.setPromptText("P1 or P2");

        Label lblTransparency = new Label("Transparency Level:");
        cmbTransparencyLevel = new ComboBox<>();
        cmbTransparencyLevel.getItems().addAll("Level 1: Fragmentation Transparency", "Level 2: Location Transparency");
        cmbTransparencyLevel.setValue("Level 1: Fragmentation Transparency");
        cmbTransparencyLevel.setPrefWidth(250);

        grid.add(lblMaNhom, 0, 0);
        grid.add(txtMaNhom, 1, 0);
        grid.add(lblTenNhom, 0, 1);
        grid.add(txtTenNhom, 1, 1);
        grid.add(lblTenPhong, 0, 2);
        grid.add(txtTenPhong, 1, 2);
        grid.add(lblTransparency, 0, 3);
        grid.add(cmbTransparencyLevel, 1, 3);

        // Buttons
        HBox buttonBox = new HBox(10);
        buttonBox.setAlignment(Pos.CENTER);

        Button btnAdd = new Button("Add");
        btnAdd.setOnAction(e -> handleAdd());

        Button btnUpdate = new Button("Update");
        btnUpdate.setOnAction(e -> handleUpdate());

        Button btnDelete = new Button("Delete");
        btnDelete.setOnAction(e -> handleDelete());

        Button btnRefresh = new Button("Refresh");
        btnRefresh.setOnAction(e -> loadData());

        Button btnQuery1 = new Button("Query 1: External Participants");
        btnQuery1.setOnAction(e -> handleQuery1());
        btnQuery1.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white;");

        Button btnQuery2 = new Button("Query 2: Update Room Name");
        btnQuery2.setOnAction(e -> handleQuery2());
        btnQuery2.setStyle("-fx-background-color: #2196F3; -fx-text-fill: white;");

        Button btnQuery3 = new Button("Query 3: Projects Without Participants");
        btnQuery3.setOnAction(e -> handleQuery3());
        btnQuery3.setStyle("-fx-background-color: #FF9800; -fx-text-fill: white;");

        buttonBox.getChildren().addAll(btnAdd, btnUpdate, btnDelete, btnRefresh, btnQuery1, btnQuery2, btnQuery3);

        vbox.getChildren().addAll(grid, buttonBox);
        return vbox;
    }

    private TableView<NhomNC> createTableView() {
        TableView<NhomNC> table = new TableView<>();

        TableColumn<NhomNC, String> colMaNhom = new TableColumn<>("Mã Nhóm");
        colMaNhom.setCellValueFactory(cellData -> cellData.getValue().maNhomProperty());
        colMaNhom.setPrefWidth(150);

        TableColumn<NhomNC, String> colTenNhom = new TableColumn<>("Tên Nhóm");
        colTenNhom.setCellValueFactory(cellData -> cellData.getValue().tenNhomProperty());
        colTenNhom.setPrefWidth(300);

        TableColumn<NhomNC, String> colTenPhong = new TableColumn<>("Tên Phòng");
        colTenPhong.setCellValueFactory(cellData -> cellData.getValue().tenPhongProperty());
        colTenPhong.setPrefWidth(150);

        table.getColumns().addAll(colMaNhom, colTenNhom, colTenPhong);
        return table;
    }

    /**
     * Handle Add operation - Insert new research group
     */
    private void handleAdd() {
        PreparedStatement ps = null;
        try {
            String maNhom = txtMaNhom.getText().trim();
            String tenNhom = txtTenNhom.getText().trim();
            String tenPhong = txtTenPhong.getText().trim();

            // Comprehensive validation
            if (maNhom.isEmpty() || tenNhom.isEmpty() || tenPhong.isEmpty()) {
                showAlert("Validation Error", "All fields are required!\n\nMã Nhóm: Research Group Code\nTên Nhóm: Research Group Name\nTên Phòng: Room Name (P1 or P2)");
                return;
            }

            if (!tenPhong.equals("P1") && !tenPhong.equals("P2")) {
                showAlert("Validation Error", "Tên Phòng must be either 'P1' or 'P2'");
                return;
            }

            // Validate maNhom format (you can customize this)
            if (maNhom.length() > 10) {
                showAlert("Validation Error", "Mã Nhóm must be 10 characters or less");
                return;
            }

            // Check database connection health
            if (!dbManager.isConnectionHealthy()) {
                showAlert("Connection Error", "Database connection is not healthy. Please restart the application.");
                return;
            }

            // Determine which server based on tenPhong (Fragment Transparency)
            Connection conn = tenPhong.equals("P1") ?
                    dbManager.getConnection1() : dbManager.getConnection2();

            // Check if record already exists
            String checkSql = "SELECT COUNT(*) FROM nhomnc WHERE manhom = ?";
            try (PreparedStatement checkPs = conn.prepareStatement(checkSql)) {
                checkPs.setString(1, maNhom);
                try (ResultSet rs = checkPs.executeQuery()) {
                    if (rs.next() && rs.getInt(1) > 0) {
                        showAlert("Duplicate Error", "Research group with code '" + maNhom + "' already exists in " + tenPhong);
                        return;
                    }
                }
            }

            // Insert the record
            String sql = "INSERT INTO nhomnc (manhom, tennhom, tenphong) VALUES (?, ?, ?)";
            ps = conn.prepareStatement(sql);
            ps.setString(1, maNhom);
            ps.setString(2, tenNhom);
            ps.setString(3, tenPhong);
            int rowsAffected = ps.executeUpdate();

            if (rowsAffected > 0) {
                showAlert("Success", "Record added successfully to " + tenPhong + "!\n\nMã Nhóm: " + maNhom);
                loadData();
                clearFields();
                txtResults.setText("Add operation successful:\nResearch group '" + maNhom + "' added to " + tenPhong);
            } else {
                showAlert("Error", "Failed to add record. No rows affected.");
            }
        } catch (SQLException e) {
            String errorMsg = "Database error during add operation:\n" + e.getMessage();
            showAlert("Database Error", errorMsg);
            txtResults.setText(errorMsg);
            e.printStackTrace();
        } catch (Exception e) {
            String errorMsg = "Unexpected error: " + e.getMessage();
            showAlert("Error", errorMsg);
            txtResults.setText(errorMsg);
            e.printStackTrace();
        } finally {
            if (ps != null) {
                try {
                    ps.close();
                } catch (SQLException e) {
                    System.err.println("Failed to close PreparedStatement: " + e.getMessage());
                }
            }
        }
    }

    /**
     * Handle Update operation - Update existing research group
     * This uses the general update function that can update any field
     */
    private void handleUpdate() {
        try {
            String maNhom = txtMaNhom.getText().trim();
            String tenNhom = txtTenNhom.getText().trim();
            String tenPhong = txtTenPhong.getText().trim();

            // Validation
            if (maNhom.isEmpty()) {
                showAlert("Validation Error", "Mã Nhóm is required to identify the record to update");
                return;
            }

            if (tenNhom.isEmpty() && tenPhong.isEmpty()) {
                showAlert("Validation Error", "Please enter at least one field to update:\n- Tên Nhóm (Research Group Name)\n- Tên Phòng (Room Name: P1 or P2)");
                return;
            }

            if (!tenPhong.isEmpty() && !tenPhong.equals("P1") && !tenPhong.equals("P2")) {
                showAlert("Validation Error", "Tên Phòng must be either 'P1' or 'P2'");
                return;
            }

            // Check database connection health
            if (!dbManager.isConnectionHealthy()) {
                showAlert("Connection Error", "Database connection is not healthy. Please restart the application.");
                return;
            }

            // Confirmation dialog
            Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
            confirmAlert.setTitle("Confirm Update");
            confirmAlert.setHeaderText("Update Research Group");
            confirmAlert.setContentText("Update record with Mã Nhóm: " + maNhom + "?");

            var result = confirmAlert.showAndWait();
            if (result.isEmpty() || result.get() != ButtonType.OK) {
                return;
            }

            int totalUpdated = 0;
            StringBuilder updateFields = new StringBuilder();

            // Build dynamic UPDATE query
            StringBuilder sqlBuilder = new StringBuilder("UPDATE nhomnc SET ");
            List<String> updates = new ArrayList<>();

            if (!tenNhom.isEmpty()) {
                updates.add("tennhom = ?");
                updateFields.append("Tên Nhóm -> ").append(tenNhom).append("\n");
            }
            if (!tenPhong.isEmpty()) {
                updates.add("tenphong = ?");
                updateFields.append("Tên Phòng -> ").append(tenPhong).append("\n");
            }

            sqlBuilder.append(String.join(", ", updates));
            sqlBuilder.append(" WHERE manhom = ?");

            String sql = sqlBuilder.toString();

            // Try updating on both servers (Location Transparency)
            for (Connection conn : new Connection[]{dbManager.getConnection1(), dbManager.getConnection2()}) {
                try (PreparedStatement ps = conn.prepareStatement(sql)) {
                    int paramIndex = 1;
                    if (!tenNhom.isEmpty()) {
                        ps.setString(paramIndex++, tenNhom);
                    }
                    if (!tenPhong.isEmpty()) {
                        ps.setString(paramIndex++, tenPhong);
                    }
                    ps.setString(paramIndex, maNhom);

                    totalUpdated += ps.executeUpdate();
                } catch (SQLException e) {
                    System.err.println("Update error on one server: " + e.getMessage());
                }
            }

            if (totalUpdated > 0) {
                showAlert("Success", "Record updated successfully!\n\nUpdated " + totalUpdated + " record(s)");
                txtResults.setText("Update operation successful:\n" + updateFields.toString());
                loadData();
            } else {
                showAlert("Not Found", "No record found with Mã Nhóm: " + maNhom);
                txtResults.setText("Update failed: Record not found");
            }

        } catch (Exception e) {
            String errorMsg = "Error during update: " + e.getMessage();
            showAlert("Error", errorMsg);
            txtResults.setText(errorMsg);
            e.printStackTrace();
        }
    }

    /**
     * Handle Delete operation - Delete research group from distributed database
     */
    private void handleDelete() {
        PreparedStatement ps1 = null;
        PreparedStatement ps2 = null;
        try {
            String maNhom = txtMaNhom.getText().trim();

            // Validation
            if (maNhom.isEmpty()) {
                showAlert("Validation Error", "Please enter Mã Nhóm (Research Group Code) to delete");
                return;
            }

            // Check database connection health
            if (!dbManager.isConnectionHealthy()) {
                showAlert("Connection Error", "Database connection is not healthy. Please restart the application.");
                return;
            }

            // Confirmation dialog
            Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
            confirmAlert.setTitle("Confirm Delete");
            confirmAlert.setHeaderText("Delete Research Group");
            confirmAlert.setContentText("Are you sure you want to delete research group: " + maNhom + "?\n\nThis action cannot be undone.");
            confirmAlert.getButtonTypes().setAll(ButtonType.YES, ButtonType.NO);

            var result = confirmAlert.showAndWait();
            if (result.isEmpty() || result.get() != ButtonType.YES) {
                txtResults.setText("Delete operation cancelled by user.");
                return;
            }

            String sql = "DELETE FROM nhomnc WHERE manhom = ?";
            int totalDeleted = 0;

            // Try deleting from Server 1 (P1)
            try {
                ps1 = dbManager.getConnection1().prepareStatement(sql);
                ps1.setString(1, maNhom);
                int rows1 = ps1.executeUpdate();
                totalDeleted += rows1;
                if (rows1 > 0) {
                    System.out.println("Deleted " + rows1 + " record(s) from Server 1 (P1)");
                }
            } catch (SQLException e) {
                System.err.println("Error deleting from Server 1: " + e.getMessage());
            }

            // Try deleting from Server 2 (P2)
            try {
                ps2 = dbManager.getConnection2().prepareStatement(sql);
                ps2.setString(1, maNhom);
                int rows2 = ps2.executeUpdate();
                totalDeleted += rows2;
                if (rows2 > 0) {
                    System.out.println("Deleted " + rows2 + " record(s) from Server 2 (P2)");
                }
            } catch (SQLException e) {
                System.err.println("Error deleting from Server 2: " + e.getMessage());
            }

            if (totalDeleted > 0) {
                showAlert("Success", "Record deleted successfully!\n\nDeleted " + totalDeleted + " record(s) from distributed database.");
                txtResults.setText("Delete operation successful:\nResearch group '" + maNhom + "' has been removed.");
                loadData();
                clearFields();
            } else {
                showAlert("Not Found", "No record found with Mã Nhóm: " + maNhom);
                txtResults.setText("Delete failed: Record not found in any server.");
            }

        } catch (Exception e) {
            String errorMsg = "Error during delete operation: " + e.getMessage();
            showAlert("Error", errorMsg);
            txtResults.setText(errorMsg);
            e.printStackTrace();
        } finally {
            // Clean up resources
            if (ps1 != null) {
                try {
                    ps1.close();
                } catch (SQLException e) {
                    System.err.println("Failed to close PreparedStatement 1: " + e.getMessage());
                }
            }
            if (ps2 != null) {
                try {
                    ps2.close();
                } catch (SQLException e) {
                    System.err.println("Failed to close PreparedStatement 2: " + e.getMessage());
                }
            }
        }
    }

    /**
     * Câu 1: Query projects with external participants
     * Demonstrates both Level 1 (Fragmentation Transparency) and Level 2 (Location Transparency)
     */
    private void handleQuery1() {
        try {
            String maNhom = txtMaNhom.getText().trim();
            if (maNhom.isEmpty()) {
                showAlert("Validation Error", "Please enter Mã Nhóm (Research Group Code) to execute Query 1");
                return;
            }

            // Check database connection health
            if (!dbManager.isConnectionHealthy()) {
                showAlert("Connection Error", "Database connection is not healthy. Please restart the application.");
                return;
            }

            boolean isLevel1 = cmbTransparencyLevel.getValue().startsWith("Level 1");
            List<String[]> results;
            StringBuilder sb = new StringBuilder();

            if (isLevel1) {
                // LEVEL 1: Fragmentation Transparency
                // User queries global schema, doesn't know about fragments
                sb.append("=== Câu 1: LEVEL 1 - FRAGMENTATION TRANSPARENCY ===\n");
                sb.append("User Query: SELECT projects from DEAN where manhom='").append(maNhom).append("' AND has external participants\n");
                sb.append("System Action: Automatically query all fragments (user doesn't know they exist)\n");
                sb.append("=================================================\n\n");

                results = dbManager.query1_Level1_FragmentationTransparency(maNhom);
            } else {
                // LEVEL 2: Location Transparency
                // User knows fragment names but not their physical locations
                sb.append("=== Câu 1: LEVEL 2 - LOCATION TRANSPARENCY ===\n");
                sb.append("User Query: Query fragments DEAN_P1 and DEAN_P2 for manhom='").append(maNhom).append("'\n");
                sb.append("System Action: Map DEAN_P1→Server1, DEAN_P2→Server2 (user doesn't know locations)\n");
                sb.append("===============================================\n\n");

                List<String> fragments = Arrays.asList("DEAN_P1", "DEAN_P2");
                results = dbManager.query1_Level2_LocationTransparency(maNhom, fragments);
            }

            if (results.isEmpty()) {
                sb.append("No projects found with external participants from other research groups.");
            } else {
                sb.append("Found ").append(results.size()).append(" project(s):\n\n");
                int count = 1;
                for (String[] row : results) {
                    sb.append(count++).append(". Project ID: ").append(row[0])
                            .append("\n   Project Name: ").append(row[1]).append("\n\n");
                }
            }
            txtResults.setText(sb.toString());
            showAlert("Query Success", "Query executed successfully at " + (isLevel1 ? "Level 1" : "Level 2") + ". Found " + results.size() + " result(s).");
        } catch (IllegalArgumentException e) {
            showAlert("Validation Error", e.getMessage());
            txtResults.setText("Query 1 failed: " + e.getMessage());
        } catch (SQLException e) {
            showAlert("Database Error", "Query 1 execution error: " + e.getMessage());
            txtResults.setText("Query 1 failed due to database error:\n" + e.getMessage());
        } catch (Exception e) {
            showAlert("Error", "Unexpected error: " + e.getMessage());
            txtResults.setText("Query 1 failed: " + e.getMessage());
        }
    }

    /**
     * Câu 2: Update room name based on user input
     * Demonstrates both Level 1 (Fragmentation Transparency) and Level 2 (Location Transparency)
     */
    private void handleQuery2() {
        try {
            // Get values from input fields
            String maNhom = txtMaNhom.getText().trim();
            String newTenPhong = txtTenPhong.getText().trim();

            // Validation - both fields are required
            if (maNhom.isEmpty()) {
                showAlert("Validation Error", "Please enter Mã Nhóm (Research Group Code) to update.\n\nExample: NC01");
                return;
            }

            if (newTenPhong.isEmpty()) {
                showAlert("Validation Error", "Please enter new Tên Phòng (Room Name) in the Tên Phòng field.\n\nExample: P2");
                return;
            }

            // Validate new room name is P1 or P2
            if (!newTenPhong.equals("P1") && !newTenPhong.equals("P2")) {
                showAlert("Validation Error", "Tên Phòng must be either 'P1' or 'P2'.\n\nYou entered: " + newTenPhong);
                return;
            }

            final String finalMaNhom = maNhom;
            final String finalNewTenPhong = newTenPhong;

            // Check database connection health
            if (!dbManager.isConnectionHealthy()) {
                showAlert("Connection Error", "Database connection is not healthy. Please restart the application.");
                return;
            }

            // Confirmation dialog
            boolean isLevel1 = cmbTransparencyLevel.getValue().startsWith("Level 1");
            Alert confirmAlert = new Alert(Alert.AlertType.CONFIRMATION);
            confirmAlert.setTitle("Confirm Update - " + (isLevel1 ? "Level 1" : "Level 2"));
            confirmAlert.setHeaderText("Update Room Name");
            confirmAlert.setContentText("Update TenPhong from 'P1' to '" + newTenPhong + "' for research group '" + maNhom + "'?\n\n" +
                    (isLevel1 ? "Level 1: System will search all fragments automatically" :
                            "Level 2: System will update specified fragments (NHOMNC_P1, NHOMNC_P2)"));

            var result = confirmAlert.showAndWait();
            if (result.isPresent() && result.get() == ButtonType.OK) {
                int rowsUpdated;
                StringBuilder sb = new StringBuilder();

                if (isLevel1) {
                    // LEVEL 1: Fragmentation Transparency
                    sb.append("=== Câu 2: LEVEL 1 - FRAGMENTATION TRANSPARENCY ===\n");
                    sb.append("User Query: UPDATE NHOMNC SET tenphong='").append(newTenPhong)
                            .append("' WHERE manhom='").append(maNhom).append("' AND tenphong='P1'\n");
                    sb.append("System Action: Search all fragments automatically\n");
                    sb.append("=================================================\n\n");

                    rowsUpdated = dbManager.query2_Level1_FragmentationTransparency(maNhom, newTenPhong);
                } else {
                    // LEVEL 2: Location Transparency
                    sb.append("=== Câu 2: LEVEL 2 - LOCATION TRANSPARENCY ===\n");
                    sb.append("User Query: UPDATE fragments NHOMNC_P1, NHOMNC_P2 SET tenphong='").append(newTenPhong)
                            .append("' WHERE manhom='").append(maNhom).append("' AND tenphong='P1'\n");
                    sb.append("System Action: Map NHOMNC_P1→Server1, NHOMNC_P2→Server2 (user doesn't know locations)\n");
                    sb.append("===============================================\n\n");

                    List<String> fragments = Arrays.asList("NHOMNC_P1", "NHOMNC_P2");
                    rowsUpdated = dbManager.query2_Level2_LocationTransparency(maNhom, newTenPhong, fragments);
                }

                sb.append("Successfully updated ").append(rowsUpdated).append(" record(s).\n");
                sb.append("Changed TenPhong from 'P1' to '").append(newTenPhong).append("' for Mã Nhóm '").append(maNhom).append("'");

                txtResults.setText(sb.toString());
                showAlert("Update Success", "Updated " + rowsUpdated + " record(s) successfully!\n\n" +
                        "Research Group: " + maNhom + "\n" +
                        "New Room: " + newTenPhong + "\n" +
                        "Transparency: " + (isLevel1 ? "Level 1" : "Level 2"));

                // Refresh table to show changes
                loadData();
                clearFields();
            }
        } catch (IllegalArgumentException e) {
            showAlert("Validation Error", e.getMessage());
            txtResults.setText("=== Câu 2 Validation Error ===\n" + e.getMessage());
        } catch (SQLException e) {
            String errorMsg = "Database error during update:\n" + e.getMessage();
            showAlert("Database Error", errorMsg);
            txtResults.setText("=== Câu 2 Database Error ===\n" + errorMsg);
        } catch (Exception e) {
            String errorMsg = "Unexpected error: " + e.getMessage();
            showAlert("Error", errorMsg);
            txtResults.setText("=== Câu 2 Error ===\n" + errorMsg);
            e.printStackTrace();
        }
    }

    /**
     * Câu 3: Get projects without any employee participation
     * Demonstrates both Level 1 (Fragmentation Transparency) and Level 2 (Location Transparency)
     */
    private void handleQuery3() {
        try {
            // Check database connection health
            if (!dbManager.isConnectionHealthy()) {
                showAlert("Connection Error", "Database connection is not healthy. Please restart the application.");
                return;
            }

            boolean isLevel1 = cmbTransparencyLevel.getValue().startsWith("Level 1");
            List<String[]> results;
            StringBuilder sb = new StringBuilder();

            if (isLevel1) {
                // LEVEL 1: Fragmentation Transparency
                sb.append("=== Câu 3: LEVEL 1 - FRAGMENTATION TRANSPARENCY ===\n");
                sb.append("User Query: SELECT projects from DEAN WHERE NOT EXISTS participation\n");
                sb.append("System Action: Automatically query all fragments\n");
                sb.append("=================================================\n\n");

                results = dbManager.query3_Level1_FragmentationTransparency();
            } else {
                // LEVEL 2: Location Transparency
                sb.append("=== Câu 3: LEVEL 2 - LOCATION TRANSPARENCY ===\n");
                sb.append("User Query: Query fragments DEAN_P1 and DEAN_P2 for projects without participants\n");
                sb.append("System Action: Map fragments to servers (user doesn't know locations)\n");
                sb.append("===============================================\n\n");

                List<String> fragments = Arrays.asList("DEAN_P1", "DEAN_P2");
                results = dbManager.query3_Level2_LocationTransparency(fragments);
            }

            if (results.isEmpty()) {
                sb.append("All projects have at least one employee participant.\n");
                sb.append("No projects found without participants.");
            } else {
                sb.append("Found ").append(results.size()).append(" project(s) without participants:\n\n");
                int count = 1;
                for (String[] row : results) {
                    sb.append(count++).append(". Project ID: ").append(row[0])
                            .append("\n   Project Name: ").append(row[1]).append("\n\n");
                }
            }
            txtResults.setText(sb.toString());
            showAlert("Query Success", "Query executed successfully at " + (isLevel1 ? "Level 1" : "Level 2") + ". Found " + results.size() + " result(s).");
        } catch (SQLException e) {
            showAlert("Database Error", "Query 3 execution error: " + e.getMessage());
            txtResults.setText("Query 3 failed due to database error:\n" + e.getMessage());
        } catch (Exception e) {
            showAlert("Error", "Unexpected error: " + e.getMessage());
            txtResults.setText("Query 3 failed: " + e.getMessage());
        }
    }

    private void loadData() {
        tableView.getItems().clear();
        try {
            loadFromServer(dbManager.getConnection1());
            loadFromServer(dbManager.getConnection2());
        } catch (SQLException e) {
            showAlert("Error", "Load data error: " + e.getMessage());
        }
    }

    private void loadFromServer(Connection conn) throws SQLException {
        String sql = "SELECT manhom, tennhom, tenphong FROM nhomnc";
        try (Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery(sql)) {
            while (rs.next()) {
                tableView.getItems().add(new NhomNC(
                        rs.getString("manhom"),
                        rs.getString("tennhom"),
                        rs.getString("tenphong")
                ));
            }
        }
    }

    private void clearFields() {
        txtMaNhom.clear();
        txtTenNhom.clear();
        txtTenPhong.clear();
    }

    private void showAlert(String title, String content) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(content);
        alert.showAndWait();
    }

    private void closeDatabase() {
        try {
            if (dbManager != null) {
                dbManager.closeConnections();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static void main(String[] args) {
        launch(args);
    }
}
